function m(r){try{return new URL(r).protocol==="https:"}catch{return!1}}async function h(){return new Promise((r,e)=>{chrome.storage.local.get(["provider","openaiKey","anthropicKey","customKey","customBaseURL","openaiModel","anthropicModel","customModel"],i=>{if(chrome.runtime.lastError){e(new Error(chrome.runtime.lastError.message));return}const t=i,o=t.provider||"openai";let s="",n,a;if(o==="openai")s=t.openaiKey||"",a=t.openaiModel||"gpt-3.5-turbo";else if(o==="anthropic")s=t.anthropicKey||"",a=t.anthropicModel||"claude-3-haiku-20240307";else if(s=t.customKey||"",n=t.customBaseURL||"",a=t.customModel||"gpt-3.5-turbo",n&&!m(n)){e(new Error("自定义API必须使用HTTPS协议"));return}r({provider:o,apiKey:s,baseURL:n,model:a})})})}async function p(r,e,i){var s,n;const t=new AbortController,o=setTimeout(()=>t.abort(),3e4);try{const a=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({model:e,messages:[{role:"user",content:i}],temperature:.7,max_tokens:2e3}),signal:t.signal});if(clearTimeout(o),!a.ok){const l=await a.json();throw console.error("OpenAI API error:",l),new Error("API请求失败，请检查配置")}return((n=(s=(await a.json()).choices[0])==null?void 0:s.message)==null?void 0:n.content)||"无法获取响应"}catch(a){throw clearTimeout(o),a instanceof Error&&a.name==="AbortError"?new Error("请求超时，请稍后重试"):a}}async function d(r,e,i){var s;const t=new AbortController,o=setTimeout(()=>t.abort(),3e4);try{const n=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:e,max_tokens:2e3,messages:[{role:"user",content:i}]}),signal:t.signal});if(clearTimeout(o),!n.ok){const c=await n.json();throw console.error("Anthropic API error:",c),new Error("API请求失败，请检查配置")}return((s=(await n.json()).content[0])==null?void 0:s.text)||"无法获取响应"}catch(n){throw clearTimeout(o),n instanceof Error&&n.name==="AbortError"?new Error("请求超时，请稍后重试"):n}}async function f(r,e,i,t){var n,a;if(!m(r))throw new Error("自定义API必须使用HTTPS协议");const o=new AbortController,s=setTimeout(()=>o.abort(),3e4);try{const c=await fetch(`${r}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:i,messages:[{role:"user",content:t}],temperature:.7,max_tokens:2e3}),signal:o.signal});if(clearTimeout(s),!c.ok)throw console.error("Custom API error:",c.status),new Error("API请求失败，请检查配置");return((a=(n=(await c.json()).choices[0])==null?void 0:n.message)==null?void 0:a.content)||"无法获取响应"}catch(c){throw clearTimeout(s),c instanceof Error&&c.name==="AbortError"?new Error("请求超时，请稍后重试"):c}}async function u(r){const e=await h();if(!e.apiKey)throw new Error("请先在设置中配置API Key");if(e.provider==="openai")return p(e.apiKey,e.model||"gpt-3.5-turbo",r);if(e.provider==="anthropic")return d(e.apiKey,e.model||"claude-3-haiku-20240307",r);if(!e.baseURL)throw new Error("请配置自定义API地址");return f(e.baseURL,e.apiKey,e.model||"gpt-3.5-turbo",r)}function g(r,e){return e==="zh"?`请总结以下网页内容的要点，用简洁的中文列出3-5个关键点：

标题：${r.substring(0,1e4)}`:`Please summarize the key points of the following web content in 3-5 bullet points:

${r.substring(0,1e4)}`}function w(r,e){return e==="zh"?`请将以下内容翻译成自然的英文：

${r.substring(0,8e3)}`:`Please translate the following content into natural Chinese:

${r.substring(0,8e3)}`}async function y(r){try{const[e,i]=await Promise.all([u(g(r.content,r.language)),u(w(r.content,r.language))]);return{summary:e,translation:i}}catch(e){throw e}}chrome.runtime.onMessage.addListener((r,e,i)=>{if(r.type==="ANALYZE_CONTENT")return y(r.data).then(t=>{var o;chrome.tabs.sendMessage(((o=e.tab)==null?void 0:o.id)||0,{type:"ANALYSIS_RESULT",data:t}),i({success:!0})}).catch(t=>{var o;chrome.tabs.sendMessage(((o=e.tab)==null?void 0:o.id)||0,{type:"ANALYSIS_RESULT",data:{error:t.message}}),i({success:!1,error:t.message})}),!0;r.type==="SHOW_SIDEBAR"&&chrome.tabs.query({active:!0,currentWindow:!0},t=>{var o;(o=t[0])!=null&&o.id&&chrome.tabs.sendMessage(t[0].id,{type:"SHOW_SIDEBAR"})})});chrome.runtime.onInstalled.addListener(()=>{console.log("网页总结翻译器已安装"),chrome.runtime.openOptionsPage()});console.log("Background Service Worker已加载");
