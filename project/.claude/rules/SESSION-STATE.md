# SESSION-STATE.md — WAL协议核心记录

> Write-Ahead Log：关键信息先写后答，然后回答

---

## 使用说明

**触发场景**（出现以下情况立即写入此文件）：
- ✏️ **修正**："是X不是Y" / "其实是..." / "不，我是..."
- 📍 **专有名词**：人名、地名、公司、产品
- 🎨 **偏好**：颜色、风格、方法、"我喜欢/不喜欢"
- 📋 **决策**："我们做X" / "用Y" / "用Z"
- 📝 **草稿修改**：正在编辑的内容变更
- 🔢 **具体值**：数字、日期、ID、URL

**规则**：出现以上任一情况 → 立即写此文件 → 然后回答

---

## 记录区

### 📝 记录格式

```
[日期时间] 标签 内容
```

**标签对应**：
- `✏️` 修正
- `📍` 专有名词
- `🎨` 偏好
- `📋` 决策
- `📝` 草稿修改
- `🔢` 具体值

---

## 历史记录

### 2026-02-20

**[2026-02-20] 📋 决策：建立五层记忆结构**
- 🔴 L1 置顶区：WAL协议核心记录
- 🟠 L2 高频区：30天内调用≥3次
- 🟡 L3 时新区：最近7天关键信息
- 🟢 L4 知识区：体系化内容
- ⚪ L5 日记区：原始记录（周度清理）

**[2026-02-20] 📋 决策：创建workspace/CAPTURE.md快速记录机制**
- Karpathy式单文件极简主义
- 随时可记，不纠结格式
- 周度整理，有价值内容进入正式记忆系统

---

---

### 2026-02-21

**[2026-02-21] 📋 决策：Token优化 - 会话轮数限制**

**问题根源**：
- 每次交互带全部历史消息
- 30轮 × 20k = 600k tokens（可控）
- 超过50轮后边际价值递减

**已完成的优化**：
- skills目录：13M → 8.3M（删除150个文件）
- XSD schema：106个 → 0
- CSV数据：96个 → 0
- JSON模板：14个 → 0

**核心方案**：
- 每20-30轮 → 新建会话
- 话题切换即新会话
- 一次问清楚，给明确需求

**提醒机制**：
- ⚠️ 超过30轮时，主动提醒年老师是否新建会话
- 可以用 heartbeat 机制或定时检查

---

*最后更新：2026-02-21*
